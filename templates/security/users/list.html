{% extends 'home.html' %} 
<title>{% block title %}{{title}}{% endblock %}</title>
{% block content %}
    {% load static %}
    {% include 'fragments/messages.html' %}
    
    <!-- Header con diseño moderno -->
    <div class="relative mb-8">
        <!-- Fondo con efecto de gradiente y formas -->
        <div class="absolute inset-0 header-gradient rounded-3xl shadow-lg overflow-hidden z-0">
            <!-- Formas decorativas -->
            <div class="absolute -right-20 -top-20 w-64 h-64 rounded-full bg-green-300 opacity-20 filter blur-xl"></div>
            <div class="absolute right-40 bottom-10 w-40 h-40 rounded-full bg-emerald-300 opacity-20 filter blur-xl"></div>
            <div class="absolute left-20 -bottom-10 w-48 h-48 rounded-full bg-teal-300 opacity-20 filter blur-xl"></div>
        </div>
        
        <!-- Contenido del header -->
        <div class="relative z-10 p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center space-y-6 md:space-y-0">
                    <!-- Título y descripción -->
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mr-5 shadow-lg border border-white/10">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">{{ title1 }}</h1>
                            <p class="text-green-100 text-lg mt-2">Administra los usuarios del sistema</p>
                            <div class="flex items-center mt-3 text-white/80 text-sm">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span>Crea, edita y administra permisos para los usuarios de la plataforma</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6">
                        {% if permissions.add_user %}
                        <button onclick="openCreateUserModal()" class="group bg-esmerald-perso text-white px-8 py-4 rounded-xl shadow-lg hover:bg-emerald-600 transition-all duration-300 flex items-center font-semibold transform hover:scale-105 animate-button-float">
                            <i class="fa-solid fa-user-plus mr-3 group-hover:scale-110 transition-transform duration-300"></i>
                            <span>Nuevo Usuario</span>
                        </button>
                        {% endif %}
                        <a href="{% url 'home' %}" class="bg-white/15 backdrop-blur-md text-white px-6 py-4 rounded-xl hover:bg-white/25 transition-all duration-300 flex items-center shadow-lg transform hover:scale-105 animate-button-float-delay">
                            <i class="fa-solid fa-house mr-3"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Barra de estadísticas -->
            <div class="max-w-7xl mx-auto mt-8 py-4 px-6 bg-white/10 backdrop-blur-md rounded-xl flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i class="fas fa-user-friends text-white"></i>
                    </div>
                    <div>
                        <div class="text-white font-bold text-xl">{{ total_users|default:"0" }}</div>
                        <div class="text-white/70 text-xs">Total usuarios</div>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i class="fas fa-user-check text-white"></i>
                    </div>
                    <div>
                        <div class="text-white font-bold text-xl">{{ active_users|default:"0" }}</div>
                        <div class="text-white/70 text-xs">Usuarios activos</div>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i class="fas fa-user-shield text-white"></i>
                    </div>
                    <div>
                        <div class="text-white font-bold text-xl">{{ staff_users|default:"0" }}</div>
                        <div class="text-white/70 text-xs">Administradores</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vista principal con filtros y listado -->
    <div class="max-w-7xl mx-auto px-4">
        <!-- Panel superior con filtros -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 mb-8">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter text-esmerald-perso mr-2"></i>
                    Filtros avanzados
                </h2>
                
                <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Búsqueda por nombre/email/dni -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="table-search" class="block text-sm font-medium text-gray-600 mb-2">Buscar usuarios</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" name="q" id="table-search" value="{{ request.GET.q }}"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                placeholder="Buscar por nombre, email, DNI...">
                        </div>
                    </div>
                    
                    <!-- Filtro por estado (activo/inactivo) -->
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-600 mb-2">Estado</label>
                        <select id="status-filter" name="status" class="block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm">
                            <option value="">Todos los estados</option>
                            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Activos</option>
                            <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactivos</option>
                        </select>
                    </div>
                    
                    <!-- Botones de búsqueda -->
                    <div class="col-span-1 md:col-span-3 flex flex-wrap gap-4 justify-end">
                        <button type="submit" class="px-6 py-3 bg-esmerald-perso hover:bg-emerald-600 text-white font-medium rounded-lg shadow-lg transition-all duration-300 flex items-center transform hover:scale-105 animate-button-float">
                            <i class="fas fa-search mr-2"></i>
                            <span>Buscar</span>
                        </button>
                        
                        {% if request.GET.q or request.GET.status %}
                        <a href="{% url 'security:user_list' %}" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg shadow-sm transition-all duration-300 flex items-center">
                            <i class="fas fa-times mr-2"></i>
                            <span>Limpiar</span>
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Usuarios en visualización de cards -->
        <div class="mb-10">
            <!-- Encabezado de resultados -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    Usuarios del sistema
                    {% if request.GET.q %}<span class="text-gray-500 font-normal text-lg ml-2">resultados para "{{ request.GET.q }}"</span>{% endif %}
                </h2>
                <div class="text-sm text-gray-500">
                    Mostrando {{ users|length }} usuarios{% if page_obj.paginator.count > users|length %} de {{ page_obj.paginator.count }} totales{% endif %}
                </div>
            </div>
            
            <!-- Grid de tarjetas de usuarios -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for item in users %}
                <div class="user-card bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 flex flex-col border border-gray-100 group relative">
                    <!-- Cabecera con degradado personalizado -->
                    <div class="header-gradient p-5 relative transition-all duration-500">
                        <!-- Información del usuario -->
                        <div class="flex items-center justify-center mb-3">
                            <!-- Avatar/Imagen -->
                            <div class="w-24 h-24 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center transform group-hover:scale-105 transition-all duration-300 overflow-hidden border-2 border-white/30">
                                {% if item.image %}
                                <img src="{{ item.get_image }}" class="object-cover w-full h-full" alt="{{ item.get_full_name }}">
                                {% else %}
                                <i class="fas fa-user text-white text-4xl"></i>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Nombre y username -->
                        <div class="text-center text-white">
                            <h3 class="font-bold text-xl group-hover:scale-105 transform origin-center transition-all duration-300">{{ item.first_name }} {{ item.last_name }}</h3>
                            <p class="text-green-100 text-sm">@{{ item.username }}</p>
                        </div>
                        
                        <!-- Estado del usuario -->
                        <div class="absolute top-3 right-3">
                            {% if item.is_active %}
                            <span class="bg-green-400/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                                Activo
                            </span>
                            {% else %}
                            <span class="bg-red-400/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium flex items-center">
                                <span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>
                                Inactivo
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Badge para staff/superuser -->
                        {% if item.is_superuser %}
                        <div class="absolute top-3 left-3">
                            <span class="bg-yellow-400/30 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium flex items-center">
                                <i class="fas fa-crown text-yellow-300 mr-1 text-xs"></i>
                                Superusuario
                            </span>
                        </div>
                        {% elif item.is_staff %}
                        <div class="absolute top-3 left-3">
                            <span class="bg-blue-400/30 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium flex items-center">
                                <i class="fas fa-user-cog text-blue-300 mr-1 text-xs"></i>
                                Staff
                            </span>
                        </div>
                        {% endif %}
                        
                        <!-- Elementos decorativos -->
                        <div class="absolute bottom-0 right-0 w-20 h-20 bg-white/5 rounded-full -mb-10 -mr-10 group-hover:scale-150 transition-transform duration-700"></div>
                    </div>
                    
                    <!-- Cuerpo de la tarjeta -->
                    <div class="p-5 flex-1 flex flex-col justify-between bg-gradient-to-b from-white to-gray-50">
                        <!-- Datos de contacto -->
                        <div class="space-y-3">
                            <!-- Email -->
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-md bg-green-50 flex items-center justify-center mr-2">
                                    <i class="fas fa-envelope text-esmerald-perso text-sm"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <p class="text-xs text-gray-500">Email</p>
                                    <p class="text-sm text-gray-800 truncate">{{ item.email }}</p>
                                </div>
                            </div>
                            
                            <!-- DNI/Cédula -->
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-md bg-emerald-50 flex items-center justify-center mr-2">
                                    <i class="fas fa-id-card text-esmerald-perso text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">DNI/Cédula</p>
                                    <p class="text-sm text-gray-800">{{ item.dni|default:"No especificado" }}</p>
                                </div>
                            </div>
                            
                            <!-- Grupos -->
                            <div class="flex items-start">
                                <div class="w-8 h-8 rounded-md bg-teal-50 flex items-center justify-center mr-2 mt-1">
                                    <i class="fas fa-users-cog text-esmerald-perso text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Grupos</p>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% for group in item.groups.all|slice:":2" %}
                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-md">
                                                {{ group.name }}
                                            </span>
                                        {% empty %}
                                            <span class="text-gray-400 italic text-xs">Sin grupos</span>
                                        {% endfor %}
                                        {% if item.groups.all|length > 2 %}
                                            <span class="bg-gray-100 text-gray-800 text-xs px-2 py-0.5 rounded-md">
                                                +{{ item.groups.all|length|add:"-2" }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Acciones -->
                        <div class="flex justify-center items-center pt-4 mt-4 border-t border-gray-100">
                            <button onclick="openUserDetailModal('{{ item.id }}')" class="w-full text-sm inline-flex items-center justify-center bg-esmerald-perso hover:bg-emerald-600 text-white px-4 py-2.5 rounded-lg transition-all duration-300 hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-eye mr-2"></i>
                                <span>Ver detalle completo</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <!-- Estado vacío -->
                <div class="col-span-full bg-white rounded-2xl shadow-md p-10 text-center border border-dashed border-gray-200">
                    <div class="mx-auto w-32 h-32 bg-gray-50 rounded-full flex items-center justify-center mb-6 relative">
                        <div class="absolute inset-0 bg-purple-50 rounded-full animate-pulse opacity-50"></div>
                        <i class="fas fa-users text-purple-300 text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">No se encontraron usuarios</h3>
                    <p class="text-gray-500 mb-8 max-w-lg mx-auto text-lg">
                        {% if request.GET.q %}
                            No hay usuarios que coincidan con tu búsqueda "{{ request.GET.q }}".
                        {% else %}
                            No hay usuarios registrados en el sistema. Los usuarios son necesarios para acceder al sistema.
                        {% endif %}
                    </p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        {% if permissions.add_user %}
                        <button onclick="openCreateUserModal()" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-esmerald-perso to-emerald-600 text-white rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300 shadow-lg">
                            <i class="fa-solid fa-user-plus mr-2"></i> Crear primer usuario
                        </button>
                        {% endif %}
                        
                        {% if request.GET.q or request.GET.status %}
                        <a href="{% url 'security:user_list' %}" class="inline-flex items-center px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Ver todos los usuarios
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Paginación rediseñada -->
            {% if page_obj.paginator.num_pages > 1 %}
            <div class="flex justify-center mt-10">
                <nav class="inline-flex rounded-xl shadow-lg overflow-hidden" aria-label="Paginación">
                    {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="px-4 py-3 border-r border-gray-200 bg-white hover:bg-gray-50 text-gray-600 flex items-center transition-all duration-200">
                        <i class="fas fa-angle-double-left mr-2"></i>
                        <span>Inicio</span>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="px-4 py-3 border-r border-gray-200 bg-white hover:bg-gray-50 text-gray-600 flex items-center transition-all duration-200">
                        <i class="fas fa-angle-left mr-2"></i>
                        <span>Anterior</span>
                    </a>
                    {% endif %}
                    
                    <div class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium flex items-center">
                        <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                    </div>
                    
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="px-4 py-3 border-l border-gray-200 bg-white hover:bg-gray-50 text-gray-600 flex items-center transition-all duration-200">
                        <span>Siguiente</span>
                        <i class="fas fa-angle-right ml-2"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="px-4 py-3 bg-white hover:bg-gray-50 text-gray-600 flex items-center transition-all duration-200">
                        <span>Fin</span>
                        <i class="fas fa-angle-double-right ml-2"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Importar fragment para eliminar -->
    {% include 'fragments/delete.html' %}

    <!-- Modal de detalle de usuario -->
    <div id="userDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
            <!-- Header del modal -->
            <div class="header-gradient p-6 relative overflow-hidden">
                <!-- Elementos decorativos de fondo -->
                <div class="absolute inset-0 overflow-hidden opacity-20">
                    <div class="absolute -right-20 -top-20 w-64 h-64 rounded-full bg-green-300 filter blur-xl"></div>
                    <div class="absolute right-20 bottom-10 w-48 h-48 rounded-full bg-emerald-300 filter blur-xl"></div>
                    <div class="absolute left-20 bottom-10 w-48 h-48 rounded-full bg-teal-300 filter blur-xl"></div>
                </div>
                
                <div class="relative z-10 flex justify-between items-start">
                    <div class="flex items-center">
                        <div class="w-16 h-16 rounded-full bg-white/15 backdrop-blur-md flex items-center justify-center mr-4 shadow-lg overflow-hidden">
                            <img id="modalUserImage" src="" alt="" class="w-full h-full object-cover hidden">
                            <i id="modalUserIcon" class="fas fa-user text-white text-2xl"></i>
                        </div>
                        <div>
                            <h2 id="modalUserName" class="text-2xl font-extrabold text-white tracking-tight"></h2>
                            <p id="modalUserUsername" class="text-green-100 mt-1 flex items-center">
                                <i class="fas fa-at mr-2"></i>
                                <span id="modalUserStatus" class="ml-3 bg-green-500/20 backdrop-blur-sm text-white px-2 py-0.5 rounded-full text-xs font-medium flex items-center">
                                    <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                                    Activo
                                </span>
                            </p>
                        </div>
                    </div>
                    <button onclick="closeUserDetailModal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Insignias de rol -->
                <div id="modalUserBadges" class="mt-6 flex flex-wrap gap-3 relative z-10">
                    <!-- Se llenarán dinámicamente -->
                </div>
            </div>
            
            <!-- Contenido del modal -->
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Panel de información personal -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center mb-4">
                            <div class="bg-esmerald-perso/15 backdrop-blur-md p-2 rounded-lg mr-3">
                                <i class="fas fa-user text-esmerald-perso"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800">Información Personal</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Nombre completo</span>
                                <span id="modalFullName" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Username</span>
                                <span id="modalUsername" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Email</span>
                                <span id="modalEmail" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">DNI/Cédula</span>
                                <span id="modalDni" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Teléfono</span>
                                <span id="modalPhone" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Dirección</span>
                                <span id="modalDirection" class="font-medium text-sm"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel de permisos y grupos -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-500/15 backdrop-blur-md p-2 rounded-lg mr-3">
                                <i class="fas fa-users-cog text-purple-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800">Grupos y Permisos</h3>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-700 mb-2 text-sm">Grupos asignados</h4>
                            <div id="modalGroups" class="space-y-1">
                                <!-- Se llenarán dinámicamente -->
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2 text-sm">Permisos específicos</h4>
                            <div id="modalPermissions" class="space-y-1 max-h-32 overflow-y-auto">
                                <!-- Se llenarán dinámicamente -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel de información de sistema -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center mb-4">
                            <div class="bg-gray-600/15 backdrop-blur-md p-2 rounded-lg mr-3">
                                <i class="fas fa-cogs text-gray-700"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800">Información de Sistema</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">ID de usuario</span>
                                <span id="modalUserId" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Es superusuario</span>
                                <span id="modalIsSuperuser" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Es staff</span>
                                <span id="modalIsStaff" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Último acceso</span>
                                <span id="modalLastLogin" class="font-medium text-sm"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">Cuenta creada</span>
                                <span id="modalDateJoined" class="font-medium text-sm"></span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex space-x-2">
                                {% if permissions.change_user %}
                                <button id="modalEditBtn" onclick="" class="flex-1 bg-blue-50 hover:bg-blue-100 transition-colors text-blue-700 py-2 px-3 rounded-lg flex items-center justify-center text-sm">
                                    <i class="fas fa-edit mr-2"></i>
                                    <span>Editar</span>
                                </button>
                                {% endif %}
                                
                                {% if permissions.delete_user %}
                                <button id="modalDeleteBtn" onclick="" class="flex-1 bg-red-50 hover:bg-red-100 transition-colors text-red-700 py-2 px-3 rounded-lg flex items-center justify-center text-sm">
                                    <i class="fas fa-trash-alt mr-2"></i>
                                    <span>Eliminar</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Script con grupos disponibles -->
    <script type="application/json" id="available-groups-data">
        [
            {% for group in available_groups %}
            {
                "id": {{ group.id }},
                "name": "{{ group.name|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>
    
    <!-- Modal de creación de usuario -->
    <div id="createUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
            <!-- Header del modal -->
            <div class="header-gradient p-6 relative overflow-hidden">
                <!-- Elementos decorativos de fondo -->
                <div class="absolute inset-0 overflow-hidden opacity-20">
                    <div class="absolute -right-20 -top-20 w-64 h-64 rounded-full bg-green-300 filter blur-xl"></div>
                    <div class="absolute right-20 bottom-10 w-48 h-48 rounded-full bg-emerald-300 filter blur-xl"></div>
                    <div class="absolute left-20 bottom-10 w-48 h-48 rounded-full bg-teal-300 filter blur-xl"></div>
                </div>
                
                <div class="relative z-10 flex justify-between items-start">
                    <div class="flex items-center">
                        <div class="w-16 h-16 rounded-full bg-white/15 backdrop-blur-md flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-user-plus text-white text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-extrabold text-white tracking-tight">Crear Nuevo Usuario</h2>
                            <p class="text-green-100 mt-1">Complete la información para crear un usuario en el sistema</p>
                        </div>
                    </div>
                    <button onclick="closeCreateUserModal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Tabs navigation -->
            <div class="bg-gray-50 border-b border-gray-200">
                <div class="flex space-x-1 p-1">
                    <button onclick="switchTab('personal')" id="tab-personal" class="create-tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 bg-white text-esmerald-perso shadow-sm border border-gray-200">
                        <i class="fas fa-user mr-2"></i>
                        Información Personal
                    </button>
                    <button onclick="switchTab('access')" id="tab-access" class="create-tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-key mr-2"></i>
                        Acceso y Permisos
                    </button>
                    <button onclick="switchTab('groups')" id="tab-groups" class="create-tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-all duration-200 text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-users-cog mr-2"></i>
                        Grupos y Roles
                    </button>
                </div>
            </div>
            
            <!-- Modal content -->
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <form id="createUserForm" method="post" action="{% url 'security:user_create' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Tab: Información Personal -->
                    <div id="tab-content-personal" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Columna izquierda -->
                            <div class="space-y-4">
                                <!-- Username -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Nombre de usuario <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                        <input type="text" name="username" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Ingrese el nombre de usuario">
                                    </div>
                                </div>
                                
                                <!-- Nombres -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Nombres <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-signature text-gray-400"></i>
                                        </div>
                                        <input type="text" name="first_name" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Ingrese los nombres">
                                    </div>
                                </div>
                                
                                <!-- Email -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Correo electrónico <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-envelope text-gray-400"></i>
                                        </div>
                                        <input type="email" name="email" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="usuario@ejemplo.com">
                                    </div>
                                </div>
                                
                                <!-- DNI -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Cédula o RUC
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-id-card text-gray-400"></i>
                                        </div>
                                        <input type="text" name="dni"
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Número de cédula o RUC">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Columna derecha -->
                            <div class="space-y-4">
                                <!-- Apellidos -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Apellidos <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-user-tag text-gray-400"></i>
                                        </div>
                                        <input type="text" name="last_name" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Ingrese los apellidos">
                                    </div>
                                </div>
                                
                                <!-- Teléfono -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Teléfono
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-phone text-gray-400"></i>
                                        </div>
                                        <input type="tel" name="phone"
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Número de teléfono">
                                    </div>
                                </div>
                                
                                <!-- Dirección -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Dirección
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-map-marker-alt text-gray-400"></i>
                                        </div>
                                        <input type="text" name="direction"
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Dirección completa">
                                    </div>
                                </div>
                                
                                <!-- Imagen -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Foto de perfil
                                    </label>
                                    <input type="file" name="image" accept="image/*"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-esmerald-perso file:text-white hover:file:bg-emerald-600 file:cursor-pointer border border-gray-200 rounded-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Acceso y Permisos -->
                    <div id="tab-content-access" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Configuración de contraseña -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800 pb-2 border-b border-gray-200 flex items-center">
                                    <i class="fas fa-key text-esmerald-perso mr-2"></i>
                                    Configuración de contraseña
                                </h3>
                                
                                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-info-circle text-blue-400"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-blue-700">
                                                La contraseña debe tener al menos 8 caracteres, incluir letras y números.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contraseña -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Contraseña <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" name="password" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Ingrese la contraseña">
                                    </div>
                                </div>
                                
                                <!-- Confirmar contraseña -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700">
                                        Confirmar contraseña <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" name="password_confirmation" required
                                            class="pl-10 block w-full py-3 px-4 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-esmerald-perso focus:border-esmerald-perso text-sm shadow-sm"
                                            placeholder="Confirme la contraseña">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estados del usuario -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800 pb-2 border-b border-gray-200 flex items-center">
                                    <i class="fas fa-user-cog text-esmerald-perso mr-2"></i>
                                    Estados del usuario
                                </h3>
                                
                                <!-- Usuario activo -->
                                <div class="flex items-start">
                                    <div class="flex items-center h-5 mt-1">
                                        <input type="checkbox" name="is_active" checked
                                            class="w-4 h-4 text-esmerald-perso bg-gray-100 border-gray-300 rounded focus:ring-esmerald-perso focus:ring-2">
                                    </div>
                                    <div class="ml-3">
                                        <label class="font-medium text-gray-700">Usuario activo</label>
                                        <p class="text-gray-500 text-sm">El usuario podrá iniciar sesión y usar el sistema</p>
                                    </div>
                                </div>
                                
                                <!-- Usuario staff -->
                                <div class="flex items-start">
                                    <div class="flex items-center h-5 mt-1">
                                        <input type="checkbox" name="is_staff"
                                            class="w-4 h-4 text-esmerald-perso bg-gray-100 border-gray-300 rounded focus:ring-esmerald-perso focus:ring-2">
                                    </div>
                                    <div class="ml-3">
                                        <label class="font-medium text-gray-700">Usuario staff</label>
                                        <p class="text-gray-500 text-sm">Acceso al panel de administración</p>
                                    </div>
                                </div>
                                
                                <!-- Superusuario -->
                                <div class="flex items-start">
                                    <div class="flex items-center h-5 mt-1">
                                        <input type="checkbox" name="is_superuser"
                                            class="w-4 h-4 text-esmerald-perso bg-gray-100 border-gray-300 rounded focus:ring-esmerald-perso focus:ring-2">
                                    </div>
                                    <div class="ml-3">
                                        <label class="font-medium text-gray-700">Superusuario</label>
                                        <p class="text-gray-500 text-sm">Acceso completo a todas las funcionalidades</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Grupos y Roles -->
                    <div id="tab-content-groups" class="tab-content hidden">
                        <div class="space-y-6">
                            <h3 class="text-lg font-semibold text-gray-800 pb-2 border-b border-gray-200 flex items-center">
                                <i class="fas fa-users-cog text-esmerald-perso mr-2"></i>
                                Asignación de grupos
                            </h3>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            Los grupos definen qué permisos tendrá el usuario en el sistema. Puede seleccionar múltiples grupos.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-medium text-gray-700">
                                        Seleccione los grupos para este usuario
                                    </label>
                                    <span id="selectedGroupsCount" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                        0 grupos seleccionados
                                    </span>
                                </div>
                                <div id="groupsContainer" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <!-- Los grupos se cargarán dinámicamente como checkboxes -->
                                    <div class="text-center text-gray-500 text-sm py-4">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>
                                        Cargando grupos disponibles...
                                    </div>
                                </div>
                                <p class="mt-2 text-sm text-gray-500">Seleccione uno o más grupos para asignar permisos al usuario</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Footer del modal -->
            <div class="bg-gray-50 px-6 py-4 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 border-t border-gray-200">
                <button onclick="closeCreateUserModal()" class="w-full sm:w-auto px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium flex items-center justify-center transition-all duration-300">
                    <i class="fas fa-times mr-2"></i>
                    <span>Cancelar</span>
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="previousTab()" id="prevTabBtn" class="hidden px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Anterior</span>
                    </button>
                    <button type="button" onclick="nextTab()" id="nextTabBtn" class="px-6 py-3 bg-esmerald-perso hover:bg-emerald-600 text-white rounded-lg font-medium flex items-center transition-all duration-300">
                        <span>Siguiente</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button type="submit" form="createUserForm" id="submitBtn" class="hidden px-8 py-3 bg-esmerald-perso hover:bg-emerald-600 text-white rounded-lg font-medium flex items-center shadow-lg transition-all duration-300">
                        <i class="fas fa-save mr-2"></i>
                        <span>Crear Usuario</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estilos adicionales -->
    <style>
        /* Colores personalizados */
        .verde-perso {
            background-color: #87f099;
        }
        
        .bg-verde-perso {
            background-color: #87f099;
        }
        
        .esmerald-perso {
            background-color: #27cb79;
        }
        
        .bg-esmerald-perso {
            background-color: #27cb79;
        }

        .text-esmerald-perso {
            color: #27cb79;
        }

        /* Gradiente personalizado para el header */
        .header-gradient {
            background: linear-gradient(135deg, #87f099 0%, #27cb79 100%);
        }

        /* Animaciones para botones flotantes */
        @keyframes button-float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-3px);
            }
        }
        
        @keyframes button-float-delay {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-2px);
            }
        }
        
        .animate-button-float {
            animation: button-float 3s ease-in-out infinite;
        }
        
        .animate-button-float-delay {
            animation: button-float-delay 3s ease-in-out infinite 0.5s;
        }

        /* Animaciones para las tarjetas */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Efecto hover para el degradado de las tarjetas */
        .user-card .header-gradient {
            background-size: 200% 200%;
            background-position: 0% 0%;
            transition: background-position 0.8s ease, transform 0.3s ease;
        }
        
        .user-card:hover .header-gradient {
            background-position: 100% 100%;
            background: linear-gradient(135deg, #27cb79 0%, #10b981 100%);
        }
        
        /* Animación para el estado vacío */
        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 0.8;
            }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Estilos para el modal de creación */
        .create-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .create-tab-btn:hover {
            transform: translateY(-1px);
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Validación de formularios */
        .form-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        .form-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }
    </style>
    
    <script>
    // Función para abrir el modal de detalle de usuario
    function openUserDetailModal(userId) {
        console.log('Abriendo modal para usuario ID:', userId);
        
        try {
            // Buscar los datos del usuario en la página usando un método más directo
            const userCards = document.querySelectorAll('.user-card');
            let userCard = null;
            
            // Buscar la tarjeta que contiene el botón con el userId
            userCards.forEach(card => {
                const button = card.querySelector(`button[onclick*="${userId}"]`);
                if (button) {
                    userCard = card;
                }
            });
            
            if (!userCard) {
                console.error('No se encontró la tarjeta de usuario para ID:', userId);
                
                // Método alternativo: buscar por el texto del botón
                userCards.forEach((card, index) => {
                    console.log(`Tarjeta ${index}:`, card.outerHTML.substring(0, 200));
                });
                
                alert('No se pudo encontrar la información del usuario. Verifique que la página esté completamente cargada.');
                return;
            }
            
            console.log('Tarjeta encontrada:', userCard);
            
            // Obtener datos básicos de forma más segura
            const h3Element = userCard.querySelector('h3');
            const userName = h3Element ? h3Element.textContent.trim() : 'Usuario desconocido';
            
            const usernameElement = userCard.querySelector('.text-green-100');
            const userUsername = usernameElement ? usernameElement.textContent.replace('@', '').trim() : 'username';
            
            // Buscar email de forma más segura
            const emailIcon = userCard.querySelector('.fa-envelope');
            let userEmail = 'No especificado';
            if (emailIcon) {
                const emailContainer = emailIcon.closest('.flex');
                if (emailContainer) {
                    const emailElement = emailContainer.querySelector('p:last-child');
                    if (emailElement) {
                        userEmail = emailElement.textContent.trim();
                    }
                }
            }
            
            // Buscar DNI de forma más segura
            const dniIcon = userCard.querySelector('.fa-id-card');
            let userDni = 'No especificado';
            if (dniIcon) {
                const dniContainer = dniIcon.closest('.flex');
                if (dniContainer) {
                    const dniElement = dniContainer.querySelector('p:last-child');
                    if (dniElement) {
                        userDni = dniElement.textContent.trim();
                    }
                }
            }
            
            console.log('Datos extraídos:', {userName, userUsername, userEmail, userDni});
            
            // Obtener imagen del usuario si existe
            const userImage = userCard.querySelector('img');
            const modalUserImage = document.getElementById('modalUserImage');
            const modalUserIcon = document.getElementById('modalUserIcon');
            
            if (userImage && modalUserImage && modalUserIcon) {
                modalUserImage.src = userImage.src;
                modalUserImage.alt = userName;
                modalUserImage.classList.remove('hidden');
                modalUserIcon.classList.add('hidden');
            } else if (modalUserImage && modalUserIcon) {
                modalUserImage.classList.add('hidden');
                modalUserIcon.classList.remove('hidden');
            }
            
            // Llenar los datos básicos de forma segura
            const elements = {
                'modalUserName': userName,
                'modalFullName': userName,
                'modalUsername': userUsername,
                'modalEmail': userEmail,
                'modalDni': userDni,
                'modalPhone': 'No especificado',
                'modalDirection': 'No especificada',
                'modalUserId': userId
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            // Actualizar username con icono
            const modalUserUsername = document.getElementById('modalUserUsername');
            if (modalUserUsername) {
                modalUserUsername.innerHTML = `<i class="fas fa-at mr-2"></i>${userUsername}`;
            }
            
            // Verificar estado activo/inactivo
            const isActive = userCard.innerHTML.includes('Activo') && !userCard.innerHTML.includes('Inactivo');
            const statusElement = document.getElementById('modalUserStatus');
            if (statusElement) {
                if (isActive) {
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>Activo';
                    statusElement.className = 'ml-3 bg-green-500/20 backdrop-blur-sm text-white px-2 py-0.5 rounded-full text-xs font-medium flex items-center';
                } else {
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>Inactivo';
                    statusElement.className = 'ml-3 bg-red-500/20 backdrop-blur-sm text-white px-2 py-0.5 rounded-full text-xs font-medium flex items-center';
                }
            }
            
            // Verificar si es superusuario o staff
            const badgesContainer = document.getElementById('modalUserBadges');
            if (badgesContainer) {
                badgesContainer.innerHTML = '';
                
                const isSuperuser = userCard.querySelector('.fa-crown') !== null;
                const isStaff = userCard.querySelector('.fa-user-cog') !== null;
                
                if (isSuperuser) {
                    badgesContainer.innerHTML += `
                        <div class="bg-yellow-500/20 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm flex items-center">
                            <i class="fas fa-crown text-yellow-300 mr-2"></i>
                            <span>Superusuario</span>
                        </div>
                    `;
                    const modalIsSuperuser = document.getElementById('modalIsSuperuser');
                    if (modalIsSuperuser) {
                        modalIsSuperuser.innerHTML = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-lg text-xs font-medium">Sí</span>';
                    }
                } else {
                    const modalIsSuperuser = document.getElementById('modalIsSuperuser');
                    if (modalIsSuperuser) {
                        modalIsSuperuser.innerHTML = '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-lg text-xs font-medium">No</span>';
                    }
                }
                
                if (isStaff) {
                    badgesContainer.innerHTML += `
                        <div class="bg-blue-500/20 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm flex items-center">
                            <i class="fas fa-user-cog text-blue-300 mr-2"></i>
                            <span>Staff</span>
                        </div>
                    `;
                    const modalIsStaff = document.getElementById('modalIsStaff');
                    if (modalIsStaff) {
                        modalIsStaff.innerHTML = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-lg text-xs font-medium">Sí</span>';
                    }
                } else {
                    const modalIsStaff = document.getElementById('modalIsStaff');
                    if (modalIsStaff) {
                        modalIsStaff.innerHTML = '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-lg text-xs font-medium">No</span>';
                    }
                }
            }
            
            // Obtener grupos del usuario
            const groupsContainer = document.getElementById('modalGroups');
            if (groupsContainer) {
                const groupElements = userCard.querySelectorAll('.bg-green-100');
                groupsContainer.innerHTML = '';
                
                if (groupElements.length > 0) {
                    groupElements.forEach(group => {
                        const groupName = group.textContent.trim();
                        if (!groupName.startsWith('+')) {
                            groupsContainer.innerHTML += `
                                <div class="bg-green-50 text-green-800 px-3 py-1 rounded-lg flex items-center text-sm">
                                    <i class="fas fa-users text-green-600 mr-2"></i>
                                    <span>${groupName}</span>
                                </div>
                            `;
                            
                            if (badgesContainer) {
                                badgesContainer.innerHTML += `
                                    <div class="bg-green-500/20 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm flex items-center">
                                        <i class="fas fa-users text-green-300 mr-2"></i>
                                        <span>${groupName}</span>
                                    </div>
                                `;
                            }
                        }
                    });
                } else {
                    groupsContainer.innerHTML = '<div class="text-gray-500 italic text-sm">No pertenece a ningún grupo</div>';
                }
            }
            
            // Permisos específicos (simulados)
            const permissionsContainer = document.getElementById('modalPermissions');
            if (permissionsContainer) {
                permissionsContainer.innerHTML = '<div class="text-gray-500 italic text-sm">No tiene permisos específicos asignados</div>';
            }
            
            // Datos de sistema (simulados)
            const modalLastLogin = document.getElementById('modalLastLogin');
            const modalDateJoined = document.getElementById('modalDateJoined');
            
            if (modalLastLogin) modalLastLogin.textContent = 'Nunca';
            if (modalDateJoined) modalDateJoined.textContent = new Date().toLocaleDateString('es-ES');
            
            // Configurar botones de acción
            const editBtn = document.getElementById('modalEditBtn');
            const deleteBtn = document.getElementById('modalDeleteBtn');
            
            if (editBtn) {
                editBtn.onclick = () => {
                    window.location.href = `{% url 'security:user_update' 0 %}`.replace('0', userId);
                };
            }
            
            if (deleteBtn) {
                deleteBtn.onclick = () => {
                    closeUserDetailModal();
                    setTimeout(() => {
                        openDeleteModal(userId, userName);
                    }, 300);
                };
            }
            
            // Mostrar el modal con animación
            const modal = document.getElementById('userDetailModal');
            if (modal) {
                modal.classList.remove('hidden');
                
                setTimeout(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.classList.add('scale-100', 'opacity-100');
                        modalContent.classList.remove('scale-95', 'opacity-0');
                    }
                }, 10);
            }
            
            console.log('Modal abierto exitosamente');
            
        } catch (error) {
            console.error('Error al abrir el modal:', error);
            console.error('Stack trace:', error.stack);
            alert('Error al cargar los detalles del usuario. Error: ' + error.message);
        }
    }
    
    // Función para cerrar el modal de detalle de usuario
    function closeUserDetailModal() {
        const modal = document.getElementById('userDetailModal');
        const modalContent = modal.querySelector('.modal-content');
        
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    // Funciones para el modal de creación de usuario
    let currentTab = 'personal';
    const tabs = ['personal', 'access', 'groups'];
    
    function openCreateUserModal() {
        const modal = document.getElementById('createUserModal');
        if (modal) {
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }
            }, 10);
            
            // Resetear al primer tab
            switchTab('personal');
            
            // Cargar grupos disponibles
            loadAvailableGroups();
        }
    }
    
    function loadAvailableGroups() {
        const groupsContainer = document.getElementById('groupsContainer');
        if (!groupsContainer) return;
        
        // Mostrar indicador de carga
        groupsContainer.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-4">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Cargando grupos disponibles...
            </div>
        `;
        
        // Obtener grupos del script JSON
        let availableGroups = [];
        try {
            const groupsScript = document.getElementById('available-groups-data');
            if (groupsScript) {
                availableGroups = JSON.parse(groupsScript.textContent);
            }
        } catch (e) {
            console.warn('Error parsing groups data:', e);
        }
        
        if (availableGroups.length > 0) {
            renderGroupsCheckboxes(availableGroups);
        } else {
            // Si no hay grupos en el contexto, usar grupos por defecto
            const defaultGroups = [
                {id: null, name: 'Administradores'},
                {id: null, name: 'Doctores'}, 
                {id: null, name: 'Empleados'},
                {id: null, name: 'Recepcionistas'},
                {id: null, name: 'Usuarios'}
            ];
            renderGroupsCheckboxes(defaultGroups);
        }
    }
    
    function extractGroupsFromPage() {
        // Esta función ya no es necesaria, pero la mantenemos por compatibilidad
        const groupsSet = new Set();
        const userCards = document.querySelectorAll('.user-card');
        
        userCards.forEach(card => {
            const groupElements = card.querySelectorAll('.bg-green-100');
            groupElements.forEach(groupElement => {
                const groupName = groupElement.textContent.trim();
                if (groupName && !groupName.startsWith('+') && groupName !== 'Sin grupos') {
                    groupsSet.add(groupName);
                }
            });
        });
        
        return Array.from(groupsSet).sort();
    }
    
    function renderGroupsCheckboxes(groups) {
        const groupsContainer = document.getElementById('groupsContainer');
        if (!groupsContainer) return;
        
        groupsContainer.innerHTML = '';
        
        if (groups.length > 0) {
            groups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-green-50 hover:border-esmerald-perso transition-all duration-200 cursor-pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'groups';
                // Usar el ID del grupo si está disponible, sino usar el nombre
                checkbox.value = group.id !== null ? group.id : group.name;
                checkbox.setAttribute('data-group-name', group.name);
                checkbox.id = `group_${group.name.toLowerCase().replace(/\s+/g, '_')}`;
                checkbox.className = 'w-4 h-4 text-esmerald-perso bg-gray-100 border-gray-300 rounded focus:ring-esmerald-perso focus:ring-2';
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'ml-3 flex items-center cursor-pointer flex-1';
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-users text-esmerald-perso mr-2';
                
                const text = document.createElement('span');
                text.className = 'text-sm font-medium text-gray-700';
                text.textContent = group.name;
                
                const description = document.createElement('span');
                description.className = 'text-xs text-gray-500 ml-auto';
                description.textContent = getGroupDescription(group.name);
                
                label.appendChild(icon);
                label.appendChild(text);
                label.appendChild(description);
                
                // Hacer que todo el div sea clickeable
                groupDiv.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateGroupDivStyle(groupDiv, checkbox.checked);
                        updateSelectedGroupsCount();
                    }
                });
                
                checkbox.addEventListener('change', function() {
                    updateGroupDivStyle(groupDiv, this.checked);
                    updateSelectedGroupsCount();
                });
                
                groupDiv.appendChild(checkbox);
                groupDiv.appendChild(label);
                
                groupsContainer.appendChild(groupDiv);
            });
        } else {
            const noGroupsDiv = document.createElement('div');
            noGroupsDiv.className = 'text-center text-gray-500 text-sm py-6';
            noGroupsDiv.innerHTML = `
                <i class="fas fa-info-circle text-blue-400 text-2xl mb-2"></i>
                <p class="font-medium">No hay grupos disponibles</p>
                <p class="text-xs mt-1">Los grupos se crearán automáticamente cuando agregue usuarios</p>
            `;
            groupsContainer.appendChild(noGroupsDiv);
        }
    }
    
    function getGroupDescription(groupName) {
        const descriptions = {
            'Administradores': 'Acceso completo',
            'Doctores': 'Personal médico',
            'Empleados': 'Personal general',
            'Recepcionistas': 'Atención al cliente',
            'Usuarios': 'Acceso básico'
        };
        return descriptions[groupName] || 'Grupo personalizado';
    }
    
    function updateGroupDivStyle(groupDiv, isChecked) {
        if (isChecked) {
            groupDiv.classList.add('bg-green-50', 'border-esmerald-perso', 'ring-2', 'ring-green-200');
            groupDiv.classList.remove('bg-white', 'border-gray-200');
        } else {
            groupDiv.classList.remove('bg-green-50', 'border-esmerald-perso', 'ring-2', 'ring-green-200');
            groupDiv.classList.add('bg-white', 'border-gray-200');
        }
    }
    
    function updateSelectedGroupsCount() {
        const checkedBoxes = document.querySelectorAll('#groupsContainer input[name="groups"]:checked');
        const countElement = document.getElementById('selectedGroupsCount');
        if (countElement) {
            const count = checkedBoxes.length;
            countElement.textContent = `${count} grupo${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
            
            if (count > 0) {
                countElement.className = 'text-xs text-white bg-esmerald-perso px-2 py-1 rounded-full';
            } else {
                countElement.className = 'text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full';
            }
        }
    }
    
    function closeCreateUserModal() {
        const modal = document.getElementById('createUserModal');
        const modalContent = modal.querySelector('.modal-content');
        
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            // Resetear el formulario
            const form = document.getElementById('createUserForm');
            if (form) {
                form.reset();
                
                // Limpiar estilos de validación
                form.querySelectorAll('.form-error, .form-success').forEach(field => {
                    field.classList.remove('form-error', 'form-success');
                });
                
                // Desmarcar todos los checkboxes de grupos
                const groupCheckboxes = form.querySelectorAll('input[name="groups"]');
                groupCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const groupDiv = checkbox.closest('div');
                    if (groupDiv) {
                        updateGroupDivStyle(groupDiv, false);
                    }
                });
                
                // Restaurar texto del botón de submit
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i><span>Crear Usuario</span>';
                    submitBtn.disabled = false;
                }
            }
        }, 300);
    }
    
    function switchTab(tabName) {
        currentTab = tabName;
        
        // Ocultar todos los contenidos de tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Mostrar el contenido del tab actual
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        
        // Actualizar estilos de los botones de tab
        document.querySelectorAll('.create-tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-esmerald-perso', 'shadow-sm', 'border', 'border-gray-200');
            btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
        });
        
        // Activar el tab actual
        const activeTab = document.getElementById(`tab-${tabName}`);
        activeTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
        activeTab.classList.add('bg-white', 'text-esmerald-perso', 'shadow-sm', 'border', 'border-gray-200');
        
        // Actualizar botones de navegación
        updateTabNavigation();
    }
    
    function updateTabNavigation() {
        const currentIndex = tabs.indexOf(currentTab);
        const prevBtn = document.getElementById('prevTabBtn');
        const nextBtn = document.getElementById('nextTabBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        // Mostrar/ocultar botón anterior
        if (currentIndex > 0) {
            prevBtn.classList.remove('hidden');
        } else {
            prevBtn.classList.add('hidden');
        }
        
        // Mostrar/ocultar botón siguiente o submit
        if (currentIndex < tabs.length - 1) {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        } else {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        }
    }
    
    function previousTab() {
        const currentIndex = tabs.indexOf(currentTab);
        if (currentIndex > 0) {
            switchTab(tabs[currentIndex - 1]);
        }
    }
    
    function nextTab() {
        const currentIndex = tabs.indexOf(currentTab);
        if (currentIndex < tabs.length - 1) {
            switchTab(tabs[currentIndex + 1]);
        }
    }

    function openDeleteModal(id, name) {
        // Configurar el modal de eliminación
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = `{% url 'security:user_delete' 0 %}`.replace('0', id);
        
        // Actualizar mensaje con animación
        const descriptionElement = document.getElementById('Description');
        descriptionElement.innerHTML = `¿Estás seguro que deseas eliminar el usuario <span class="font-semibold">"${name}"</span>?`;
        descriptionElement.innerHTML += `<p class="text-sm mt-2 text-gray-600">Esta acción no se puede deshacer. El usuario será eliminado permanentemente del sistema.</p>`;
        
        // Mostrar el modal con animación
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.classList.remove('hidden');
        
        // Animar entrada del modal
        setTimeout(() => {
            const modalContent = deleteModal.querySelector('.modal-content');
            if (modalContent) {                modalContent.classList.add('scale-100', 'opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }
        }, 10);
    }
    
    function closeModal() {
        // Animar salida del modal
        const deleteModal = document.getElementById('deleteModal');
        const modalContent = deleteModal.querySelector('.modal-content');
        
        if (modalContent) {
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            // Esperar a que termine la animación antes de ocultar
            setTimeout(() => {
                deleteModal.classList.add('hidden');
            }, 200);
        } else {
            deleteModal.classList.add('hidden');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar el evento submit del formulario de eliminación
        const deleteForm = document.getElementById('deleteForm');
        if (deleteForm) {
            deleteForm.addEventListener('submit', function(e) {
                const submitBtn = deleteForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Eliminando...';
                    submitBtn.disabled = true;
                    
                    // Agregar clase de animación al botón
                    submitBtn.classList.add('bg-red-800');
                }
            });
        }
        
        // Animación de entrada para las tarjetas
        const cards = document.querySelectorAll('.user-card');
        if (cards.length > 0) {
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.5s cubic-bezier(0.215, 0.61, 0.355, 1)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 + (index * 80)); // Escalonado para cada tarjeta
            });
        }
        
        // Agregar efecto de hover avanzado a las tarjetas
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.classList.add('shadow-xl', 'border-green-100');
            });
            
            card.addEventListener('mouseleave', function() {
                this.classList.remove('shadow-xl', 'border-green-100');
            });
        });
        
        // Animación para el panel de filtros
        const filterPanel = document.querySelector('.bg-white.rounded-2xl');
        if (filterPanel) {
            filterPanel.style.opacity = '0';
            filterPanel.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                filterPanel.style.transition = 'all 0.5s ease';
                filterPanel.style.opacity = '1';
                filterPanel.style.transform = 'translateY(0)';
            }, 100);
        }
        
        // Simulación de filtros activos
        const statusFilter = document.getElementById('status-filter');
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                // En un entorno real, esto enviaría el form automáticamente
                // pero aquí solo lo agregamos para simular la funcionalidad
            });
        }
        
        // Cerrar modal al hacer clic fuera de él
        const userDetailModal = document.getElementById('userDetailModal');
        const createUserModal = document.getElementById('createUserModal');
        
        if (userDetailModal) {
            userDetailModal.addEventListener('click', function(e) {
                if (e.target === userDetailModal) {
                    closeUserDetailModal();
                }
            });
        }
        
        if (createUserModal) {
            createUserModal.addEventListener('click', function(e) {
                if (e.target === createUserModal) {
                    closeCreateUserModal();
                }
            });
        }
        
        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const detailModal = document.getElementById('userDetailModal');
                const createModal = document.getElementById('createUserModal');
                
                if (detailModal && !detailModal.classList.contains('hidden')) {
                    closeUserDetailModal();
                } else if (createModal && !createModal.classList.contains('hidden')) {
                    closeCreateUserModal();
                }
            }
        });
        
        // Manejar envío del formulario de creación de usuario
        const createUserForm = document.getElementById('createUserForm');
        if (createUserForm) {
            createUserForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validación básica
                const requiredFields = ['username', 'first_name', 'last_name', 'email', 'password', 'password_confirmation'];
                let isValid = true;
                
                requiredFields.forEach(fieldName => {
                    const field = createUserForm.querySelector(`[name="${fieldName}"]`);
                    if (field && !field.value.trim()) {
                        field.classList.add('form-error');
                        isValid = false;
                    } else if (field) {
                        field.classList.remove('form-error');
                        field.classList.add('form-success');
                    }
                });
                
                // Validar que las contraseñas coincidan
                const password = createUserForm.querySelector('[name="password"]');
                const passwordConfirmation = createUserForm.querySelector('[name="password_confirmation"]');
                
                if (password && passwordConfirmation && password.value !== passwordConfirmation.value) {
                    passwordConfirmation.classList.add('form-error');
                    alert('Las contraseñas no coinciden');
                    isValid = false;
                } else if (password && passwordConfirmation) {
                    passwordConfirmation.classList.remove('form-error');
                    passwordConfirmation.classList.add('form-success');
                }
                
                if (isValid) {
                    // Verificar si al menos un grupo está seleccionado (opcional)
                    const selectedGroups = createUserForm.querySelectorAll('input[name="groups"]:checked');
                    if (selectedGroups.length === 0) {
                        const confirmProceed = confirm('No ha seleccionado ningún grupo. ¿Desea continuar creando el usuario sin grupos asignados?');
                        if (!confirmProceed) {
                            switchTab('groups');
                            return;
                        }
                    }
                    
                    // Mostrar indicador de carga
                    const submitBtn = document.getElementById('submitBtn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Creando usuario...';
                    submitBtn.disabled = true;
                    
                    // Enviar el formulario
                    this.submit();
                } else {
                    // Mostrar el primer tab si hay errores allí
                    const personalTabFields = createUserForm.querySelectorAll('#tab-content-personal input.form-error');
                    const accessTabFields = createUserForm.querySelectorAll('#tab-content-access input.form-error');
                    
                    if (personalTabFields.length > 0) {
                        switchTab('personal');
                    } else if (accessTabFields.length > 0) {
                        switchTab('access');
                    }
                }
            });
            
            // Limpiar estilos de error cuando el usuario empiece a escribir
            createUserForm.addEventListener('input', function(e) {
                if (e.target.classList.contains('form-error')) {
                    e.target.classList.remove('form-error');
                }
            });
        }
    });
</script>

<!-- Incluir el modal de eliminación -->
{% include 'fragments/delete.html' %}
{% endblock %}
